#!/usr/bin/env bash
set -eu

CLAUDE_DIR="${HOME}/.claude"
CREDENTIALS="${CLAUDE_DIR}/.credentials.json"
STATS_CACHE="${CLAUDE_DIR}/stats-cache.json"
PROJECTS_DIR="${CLAUDE_DIR}/projects"

TODAY=$(date +%Y-%m-%d)
SEVEN_DAYS_AGO=$(date -d "6 days ago" +%Y-%m-%d)
MONTH_START=$(date +%Y-%m-01)

# Defaults
SUBSCRIPTION_TYPE="unknown"
RATE_LIMIT_TIER="unknown"
FIVE_HOUR_UTIL=0
FIVE_HOUR_RESET=""
SEVEN_DAY_UTIL=0
SEVEN_DAY_RESET=""
EXTRA_USAGE_ENABLED="false"

WEEK_TOKENS=0
WEEK_MESSAGES=0
WEEK_SESSIONS=0
MONTH_TOKENS=0
WEEK_MODELS=""
DAILY="0,0,0,0,0,0,0"

ALLTIME_SESSIONS=0
ALLTIME_MESSAGES=0
FIRST_SESSION="unknown"

# --- Subscription & API Usage ---
if [ -f "$CREDENTIALS" ]; then
    SUBSCRIPTION_TYPE=$(jq -r '.claudeAiOauth.subscriptionType // "unknown"' "$CREDENTIALS")
    RATE_LIMIT_TIER=$(jq -r '.claudeAiOauth.rateLimitTier // "unknown"' "$CREDENTIALS")

    TOKEN=$(jq -r '.claudeAiOauth.accessToken // ""' "$CREDENTIALS")
    if [ -n "$TOKEN" ]; then
        API_RESPONSE=$(curl -s --max-time 5 \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "anthropic-beta: oauth-2025-04-20" \
            "https://api.anthropic.com/api/oauth/usage" 2>/dev/null || echo '{}')

        FIVE_HOUR_UTIL=$(echo "$API_RESPONSE" | jq -r '.five_hour.utilization // 0')
        FIVE_HOUR_RESET=$(echo "$API_RESPONSE" | jq -r '.five_hour.resets_at // ""')
        SEVEN_DAY_UTIL=$(echo "$API_RESPONSE" | jq -r '.seven_day.utilization // 0')
        SEVEN_DAY_RESET=$(echo "$API_RESPONSE" | jq -r '.seven_day.resets_at // ""')
        EXTRA_USAGE_ENABLED=$(echo "$API_RESPONSE" | jq -r '.extra_usage.is_enabled // false')
    fi
fi

# --- Token consumption from JSONL session files ---
if [ -d "$PROJECTS_DIR" ]; then
    # Pre-compute rolling 7-day dates (index 1=6 days ago ... index 7=today)
    DAY_DATES=""
    for i in 6 5 4 3 2 1 0; do
        d=$(date -d "${i} days ago" +%Y-%m-%d)
        DAY_DATES="${DAY_DATES:+${DAY_DATES},}${d}"
    done

    # Single pass: parse all session files and output final key=value pairs
    while IFS='=' read -r key value; do
        case "$key" in
            WEEK_TOKENS) WEEK_TOKENS="$value" ;;
            WEEK_MESSAGES) WEEK_MESSAGES="$value" ;;
            WEEK_SESSIONS) WEEK_SESSIONS="$value" ;;
            MONTH_TOKENS) MONTH_TOKENS="$value" ;;
            DAILY) DAILY="$value" ;;
            WEEK_MODELS) WEEK_MODELS="$value" ;;
        esac
    done < <(find "$PROJECTS_DIR" -name "*.jsonl" -mtime -31 -exec \
        jq -r 'select(.type == "assistant") | "\(.timestamp[:10]) \(.message.model // "unknown") \(.message.usage.input_tokens + .message.usage.output_tokens + .message.usage.cache_read_input_tokens + .message.usage.cache_creation_input_tokens) \(.sessionId // "unknown")"' {} + 2>/dev/null \
        | awk -v week_start="$SEVEN_DAYS_AGO" -v month_start="$MONTH_START" -v day_dates="$DAY_DATES" '
        BEGIN { split(day_dates, dates, ",") }
        {
            day[$1] += $3
            if ($1 >= week_start) {
                family = $2
                if (index(family, "opus") > 0) family = "opus"
                else if (index(family, "sonnet") > 0) family = "sonnet"
                else if (index(family, "haiku") > 0) family = "haiku"
                week_model[family] += $3
                week_tokens += $3
                week_msgs++
                week_sess[$4] = 1
            }
            if ($1 >= month_start) month_tokens += $3
        }
        END {
            printf "WEEK_TOKENS=%d\n", week_tokens + 0
            printf "WEEK_MESSAGES=%d\n", week_msgs + 0
            n = 0; for (s in week_sess) n++
            printf "WEEK_SESSIONS=%d\n", n
            printf "MONTH_TOKENS=%d\n", month_tokens + 0

            daily = ""
            for (i = 1; i <= 7; i++) {
                val = (dates[i] in day) ? day[dates[i]] : 0
                daily = daily (i > 1 ? "," : "") val + 0
            }
            printf "DAILY=%s\n", daily

            models = ""
            first = 1
            for (m in week_model) {
                if (week_model[m] > 0) {
                    models = models (first ? "" : ",") m ":" week_model[m]
                    first = 0
                }
            }
            printf "WEEK_MODELS=%s\n", models
        }')
fi

# --- All-time from stats cache (supplementary) ---
if [ -f "$STATS_CACHE" ]; then
    ALLTIME_SESSIONS=$(jq -r '.totalSessions // 0' "$STATS_CACHE" 2>/dev/null || echo 0)
    ALLTIME_MESSAGES=$(jq -r '.totalMessages // 0' "$STATS_CACHE" 2>/dev/null || echo 0)
    FIRST_SESSION=$(jq -r '.firstSessionDate // "unknown"' "$STATS_CACHE" 2>/dev/null || echo "unknown")
    FIRST_SESSION="${FIRST_SESSION%%T*}"
fi

# Output key=value pairs
echo "SUBSCRIPTION_TYPE=${SUBSCRIPTION_TYPE}"
echo "RATE_LIMIT_TIER=${RATE_LIMIT_TIER}"
echo "FIVE_HOUR_UTIL=${FIVE_HOUR_UTIL}"
echo "FIVE_HOUR_RESET=${FIVE_HOUR_RESET}"
echo "SEVEN_DAY_UTIL=${SEVEN_DAY_UTIL}"
echo "SEVEN_DAY_RESET=${SEVEN_DAY_RESET}"
echo "EXTRA_USAGE_ENABLED=${EXTRA_USAGE_ENABLED}"
echo "WEEK_MESSAGES=${WEEK_MESSAGES}"
echo "WEEK_SESSIONS=${WEEK_SESSIONS}"
echo "WEEK_TOKENS=${WEEK_TOKENS}"
echo "WEEK_MODELS=${WEEK_MODELS}"
echo "ALLTIME_SESSIONS=${ALLTIME_SESSIONS}"
echo "ALLTIME_MESSAGES=${ALLTIME_MESSAGES}"
echo "FIRST_SESSION=${FIRST_SESSION}"
echo "DAILY=${DAILY}"
echo "MONTH_TOKENS=${MONTH_TOKENS}"
